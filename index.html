<!DOCTYPE html>
<script src="https://d3js.org/d3.v4.min.js"></script>
<!-- <script src="https://unpkg.com/d3-sankey@0.7"></script> -->
<script src="src/d3-sankey.js"></script>

<style>
  .axis--x path {
    display: none;
  }
</style>

<body></body>
<script>
var margin = {top: 15, right: 100, bottom: 25, left: 150};
var width = 1500 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;
var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var x_0 = d3.scaleBand()
        .domain([1, 2, 3, 4])
        .paddingInner(0.4)
        .rangeRound([0, width]),
    x_1 = d3.scaleBand()
        .domain([1, 2])
        .padding(0.3),
    y = d3.scaleBand()
        .domain(["CS", "PSY", "MSCI", "PHIL", "IE", "GEOG", "STAT", "CINE", "MATH", "ANTH", "RELS"])
        .range([0, height]),
    y_1 = d3.scaleLinear().rangeRound([height, 0]),
    color = d3.scaleOrdinal(d3.schemeCategory10),
    colorSubjects = d3.scaleOrdinal()
      .domain(["CS", "PSY", "MSCI", "PHIL", "IE", "GEOG", "STAT", "CINE", "MATH", "ANTH", "RELS"]);

var sankey = d3.sankey()
    .nodeId(function(d) { return d.course; })
    .nodeWidth(15)
    .nodePadding(15)
    .iterations(128)
    .size([width, height]);

var link = svg.append("g")
    .attr("class", "links")
    .attr("fill", "none")
    .attr("stroke", "#000")
    .attr("stroke-opacity", 0.2)
  .selectAll("path");

var node = svg.append("g")
    .attr("class", "nodes")
    .attr("font-family", "sans-serif")
    .attr("font-size", 10)
  .selectAll("g");


d3.json("data/courses.json", function(error, courses) {
  if (error) throw error;

  // Prep: Filter and create sankey
  sankey(courses);
  //courses.nodes = courses.nodes.filter(function(d) { return d.value > 0; });

  // Data preparation: X axis
  x_1.rangeRound([0, x_0.bandwidth()]);
  courses.nodes.forEach(function(d) {
    var split = d.course.split(":");
    d.subject = split[0];
    d.courseNum = +split[1].slice(0, 4);

    d.x0 = get_course_x(d);
    d.x1 = d.x0 + x_1.bandwidth();
    return d;
  });
  var subjects = d3.set(courses.nodes.map(function(d) { return d.subject; }));

  // Data prep: Y axis
  y_1.domain(d3.extent(courses.nodes.map(function(d) { return d.courseNum; })));
  courses.nodes.forEach(function(d) {
    var nodeHight = d.y1 - d.y0;
    d.y1 = y_1(d.courseNum);
    d.y0 = d.y1 - nodeHight;

    // Make sure lower nodes don't get crowded out
    if (d.y0 < 0) {
      d.y0 = 0;
      d.y1 = nodeHight;
    }

    return d;
  });

  // DRAW
  sankey.update(courses);
  link = link
    .data(courses.links)
    .enter().append("path")
      .attr('class', 'link')
      .attr("d", d3.sankeyLinkHorizontal())
      .attr("stroke-width", function(d) { return Math.max(1, d.width); });
  node = node
     .data(courses.nodes.sort(function(a, b) {return b.targetLinks.length - a.targetLinks.length; }))
     .enter().append("g");
   node.append("rect")
      .attr('class', 'node')
      .attr("x", function(d) { return d.x0; })
      .attr("y", function(d) { return d.y0; })
      .attr("height", function(d) { return (d.y1 - d.y0) > 1 ? d.y1 - d.y0 : 10; })
      .attr("width", function(d) { return d.x1 - d.x0; })
      .attr("fill", function(d) { return color(d.name.replace(/ .*/, "")); })
      .attr("stroke", "#000");
   node.append("text")
      .attr('class', 'classLabel')
      .attr("x", function(d) { return d.x0 - 6; })
      .attr("y", function(d) { return (d.y1 + d.y0) / 2; })
      .attr("dy", "0.35em")
      .attr("text-anchor", "end")
      .text(function(d) { return d.name; })
    //.filter(function(d) { return d.x0 < width / 2; })
    .filter(function(d) { return d.semester === 2; })
      .attr("x", function(d) { return d.x1 + 6; })
      .attr("text-anchor", "start");

  // MARKINGS
  var marks = svg.append('g').attr('class', 'marks');
  marks.append('g')
    .attr('class', 'axis axis--x')
    .attr('transform', 'translate('+ -(margin.left*0.75) +','+ (height + margin.bottom*0.25) + ')')
    .call(d3.axisBottom(x_0));
  marks.append('g')
    .attr('class', 'axis axis--y')
    //.attr('transform', 'translate(0,' + (height + margin.bottom*.75) + ')')
    .call(d3.axisLeft(y_1))
    .append("text")
      .attr('x', 5)
      .attr("y", 6)
      .attr("dy", "0.71em")
      .attr("fill", "#333")
      .attr('font-weight', 'bold')
      .style('font-size', '12px')
      .style('text-anchor', 'start')
      .text("Course Number");


  console.log(courses.nodes);
});

function get_course_x(course) {
  var year = course.year,
      semester = course.semester;
  return x_0(year) + x_1(semester);
}
</script>
