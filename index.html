<!DOCTYPE html>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://unpkg.com/d3-sankey@0.7"></script>
<script src="https://unpkg.com/d3-jetpack"></script>

<style>
  body {
    font-family: Arial, sans-serif;
  }
  .node, .link {
    stroke: #333;
  }
  .link:hover {
    stroke-opacity: .5 !important;
  }
  .axis--x path {
    display: none;
  }
  .axis {
    font-weight: bold;
  }
  .chartLabel {
    font-weight: bold;
    font-size: 12px;
    fill: #333;
    text-anchor: start;
  }
</style>

<body>
  <h1>College Curriculum Diagram</h1>
</body>
<script>
var margin = {top: 15, right: 100, bottom: 35, left: 150};
var width = 1500 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;
var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

svg.append("rect")
    .attr("class", "background")
    .attr("x", -margin.left)
    .attr("y", -margin.top)
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .style("fill", "#fff");

var x_0 = d3.scaleBand()
        .domain(["Freshman", "Sophomore", "Junior", "Senior"])
        .paddingInner(0.4)
        .rangeRound([0, width]),
    x_1 = d3.scaleBand()
        .domain([1, 2])
        .padding(0.3),
    y = d3.scaleLinear().rangeRound([height, 0]),
    colorCredits = d3.scaleOrdinal()
      .domain(["Elective", "Psychology Minor", "Comp Sci Minor", "Informatics Major"])
      .range(["#a6cee3", "#1f78b4", "#b2df8a", "#33a02c"]);

var sankey = d3.sankey()
    .nodeId(function(d) { return d.course; })
    .nodeWidth(15)
    .nodePadding(15)
    .iterations(32)
    .size([width, height]);

var link = svg.append("g")
    .attr("class", "links")
    .attr("fill", "none")
    .attr("stroke", "#000")
    .attr("stroke-opacity", 0.2)
  .selectAll("path");

var node = svg.append("g")
    .attr("class", "nodes")
    .attr("font-family", "sans-serif")
    .attr("font-size", 10)
  .selectAll("g");

d3.json("data/courses.json", function(error, courses) {
  if (error) throw error;

  // Prep: Format and create sankey
  courses.nodes.forEach(format_course);
  sankey(courses);

  // Data preparation: X axis
  x_1.rangeRound([0, x_0.bandwidth()]);
  courses.nodes.forEach(function(d) {
    d.x0 = get_course_x(d);
    d.x1 = d.x0 + x_1.bandwidth();
    return d;
  });

  // Data prep: Y axis
  y.domain(d3.extent(courses.nodes.map(function(d) { return d.courseNum; })));
  courses.nodes.forEach(function(d) {
    var nodeHight = d.y1 - d.y0;
    d.y1 = y(d.courseNum);
    d.y0 = d.y1 - nodeHight;

    // Make sure lower nodes don't get crowded out
    if (d.y0 < 0) {
      d.y0 = 0;
      d.y1 = nodeHight;
    }
    // Add node height, nodes without links need explicit setting
    d.height = (d.y1-d.y0 > 1) ? d.y1-d.y0 : 15.333333333333371;

    return d;
  });

  // DRAW
  sankey.update(courses);
  link = link
    .data(courses.links)
    .enter().append("path")
      .attr("class", "link")
      .attr("id", function(d,i){ d.id = i; return "link-"+i; })
      .attr("d", d3.sankeyLinkHorizontal())
      .attr("stroke-opacity", 0.15)
      .attr("stroke-width", function(d) { return Math.max(1, d.width); });
  node = node
     .data(courses.nodes.sort(function(a, b) {return b.targetLinks.length - a.targetLinks.length; }))
     .enter().append("g")
     .on("click", highlight_node_links);
   node.append("rect")
      .attr("class", "node")
      .attr("x", function(d) { return d.x0; })
      .attr("y", function(d) { return d.y0; })
      .attr("height", function(d) { return d.height; })
      .attr("width", function(d) { return d.x1 - d.x0; })
      .attr("fill", function(d) { return colorCredits(d.credit); });
   node.append("text")
      .attr("class", "classLabel")
      .attr("x", function(d) { return d.x0 - 6; })
      .attr("y", function(d) { return d.y0 + d.height / 2; })
      .attr("dy", "0.35em")
      .attr("text-anchor", "end")
      .text(function(d) { return d.name; })
    .filter(function(d) { return d.semester === 2; })
      .attr("x", function(d) { return d.x1 + 6; })
      .attr("text-anchor", "start");

  // MARKINGS
  var marks = svg.append("g").attr("class", "marks");
  marks.append("g")
    .attr("class", "axis axis--x")
    .attr("transform", "translate("+ -(margin.left*0.75) +","+ (height + margin.bottom*0.5) + ")")
    .call(d3.axisBottom(x_0));
  // Adjust ticks to be better centered
  d3.select(".axis--x").selectAll(".tick")
      .attr("transform", function(d) {
        return "translate(" + (margin.left + x_0(d) + x_1.bandwidth() + x_1.paddingInner()/2) + ",0)";
      });
  // Add context to X
  d3.select('.axis--x').select('.tick text').text('Freshman Year');
  marks.append("g")
    .attr("class", "axis axis--y")
    .attr("transform", "translate("+ -(margin.left*0.75) +",0)")
    .call(d3.axisLeft(y).tickFormat(d3.format("d")))
    .append("text")
      .attr("class", "chartLabel")
      .attr("x", 5)
      .attr("y", 0)
      .attr("dy", "0.71em")
      .text("Course Number");

  // Legend Title
  marks.append("text")
      .attr("class", "chartLabel")
      .attr("x", 0)
      .attr("y", 0)
      .attr("dy", "0.71em")
      .text("Course Credit")
  var legend = marks.append("g")
    .attr("font-family", "sans-serif")
    .attr("font-size", 11)
    .attr("text-anchor", "start")
    .selectAll("g")
    .data(colorCredits.domain().reverse())
    .enter().append("g")
    .attr("transform", function(d, i) {
      return "translate(0," + ((i * 22) + 20) + ")";
    });
  legend.append("rect")
      .attr('class', 'node')
      .attr("x", 0)
      .attr("width", 19)
      .attr("height", 19)
      .attr("fill", colorCredits);
  legend.append("text")
      .attr("x", 24)
      .attr("y", 9.5)
      .attr("dy", "0.32em")
      .text(function(d) { return d; });

  //console.log(courses.nodes);
});

function format_course(d) {
  var split = d.course.split(":");
  d.subject = split[0];
  d.courseNum = +split[1].slice(0, 4);

  // Assign Y position here, instead of altering course numbers
  // TO BE FINISHED

  return d;
}


function get_course_x(course) {
  var year = course.year,
      semester = course.semester;
  return x_0(year) + x_1(semester);
}

function highlight_node_links(node,i){

    var remainingNodes=[],
        nextNodes=[];

    var stroke_opacity = 0;
    if( d3.select(this).attr("data-clicked") == "1" ){
      d3.select(this).attr("data-clicked","0");
      stroke_opacity = 0.2;
    }else{
      d3.select(this).attr("data-clicked","1");
      stroke_opacity = 0.5;
    }

    var traverse = [{
                      linkType : "sourceLinks",
                      nodeType : "target"
                    },{
                      linkType : "targetLinks",
                      nodeType : "source"
                    }];

    traverse.forEach(function(step){
      node[step.linkType].forEach(function(link) {
        remainingNodes.push(link[step.nodeType]);
        highlight_link(link.id, stroke_opacity);
      });

      while (remainingNodes.length) {
        nextNodes = [];
        remainingNodes.forEach(function(node) {
          node[step.linkType].forEach(function(link) {
            nextNodes.push(link[step.nodeType]);
            highlight_link(link.id, stroke_opacity);
          });
        });
        remainingNodes = nextNodes;
      }
    });
  }

function highlight_link(id,opacity){
      d3.select("#link-"+id).style("stroke-opacity", opacity);
  }
</script>
